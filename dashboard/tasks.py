import os
from datetime import date, timedelta

from django.core.mail import send_mail

from ajenta_dashboard.celery import app
from .queries import calculate_concurrent_lines


@app.task
def send_email():
    """Send an automated email with the maximum number of concurrent lines per platform."""
    username = 'All'
    start_date = end_date = date.today() - timedelta(1)

    ajenta_io_lines = calculate_concurrent_lines(username, 'ajenta.io', start_date, end_date)
    platformc_lines = calculate_concurrent_lines(username, 'platformc', start_date, end_date)

    subject = 'Maximum number of concurrent lines for ' + start_date.strftime("%d/%m/%Y")

    message = 'This is an automated email, generated by dashboard.ajenta.io\n\n' \
              'The maximum number of concurrent lines for ajenta.io on ' \
              + start_date.strftime("%d/%m/%Y") + ' was: ' + str(ajenta_io_lines[start_date]) + '.\n\n' \
              'The maximum number of concurrent lines for platformC on ' \
              + start_date.strftime("%d/%m/%Y") + ' was: ' + str(platformc_lines[start_date])

    # The emails in the EMAIL_LIST environment variable should be separated by one space
    # (e.g EMAIL_LIST='email1@domain.com email2@domain.com')
    send_mail(subject, message, os.environ['EMAIL_HOST_USER'], os.environ['EMAIL_LIST'].split(), fail_silently=False)
